require 'rake/clean'
include Rake::DSL


ROOT = File.dirname(__FILE__)
NAME = File.basename(ROOT)


task :default => [:watch]


HAML = FileList['**/*.haml']
HTML = HAML.ext('html')
SCSS = FileList['css/*.scss']
CSS = SCSS.ext('css')


CLEAN.include HTML + CSS


desc 'Compiles HAML and SCSS resources'
task :compile => HTML + CSS


desc 'Watches the site directory and regenerates when files change'
task :watch => [:compile] do |t, args|
    listen
    sleep
end


desc 'Starts wordpress dev server'
task :wordpress => [:compile] do |t|
    listen
    sh "cd howmany_wordpress/-wp && wp server"
end


desc 'Packages plugins'
task :package => [:compile] do |t|
    sh "mkdir ./-package" if not File.exist? './-package'
    sh "rsync -vr --copy-links --exclude='-wp' howmany_wordpress ./-package/"
end


rule '.html' => '.haml' do |t|
    puts "Rebuilding #{t.name}"
    sh "haml -I \"lib\" -r \"php.rb\" \"#{t.source}\" \"#{t.name}\"" do |ok, res| end
end


rule '.css' => '.scss' do |t|
    puts "Rebuilding #{t.name}"
    sh "sass #{t.source} #{t.name}" do |ok, res| end
end


def listen
    require 'listen'
    Listen.to("partials", "css", "howmany_wordpress/views", :relative_paths => true, :only => /\.(haml|scss)$/) do |mod, add, rem|
        changed = mod or add or rem
        changed = changed.first.to_s
        puts "Changed #{changed}"
        sh "rake compile"
    end.start
end
